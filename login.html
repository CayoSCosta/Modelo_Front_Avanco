<?php include 'layout/header.php'; ?>

<div class="contact" id="contact">
    <div class="box-container">
        <div class="box">

            <div id="mensagem-banner" class="alert" style="display: none;">
                <div id="progress-bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                <div id="mensagem-texto"></div>
            </div>

            <h4 class="contato" style="font-weight: bold;">Faça login para acessar sua conta</h4>
            <form id="login" action="#" method="post" onsubmit="return realizarLogin()">
                <div class="col">
                    <label for="email">E-mail*</label>
                    <input type="email" name="email" id="email" class="form-control">
                </div>

                <div class="col">
                    <label for="senha">Senha*</label>
                    <input type="password" name="password" id="password">
                </div>

                <div class="btn-contato">
                    <input class="btn-submit" type="submit" value="Login">
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    function realizarLogin() {
        var formulario = document.getElementById("login");
        var dadosFormulario = new FormData(formulario);

        fetch("..\\db\\processarLogin.php", {
                method: "POST",
                body: dadosFormulario
            })
            .then(response => {
                console.log(response); // Log da resposta HTTP (opcional)
                return response.text(); // Use response.text() em vez de response.json()
            })
            .then(data => {
                console.log("Passou pelo data: " + data);
                // Agora, você pode ver o conteúdo real do corpo da resposta JSON
                var jsonData = JSON.parse(data);

                // Exibir mensagem de alerta conforme a resposta do servidor
                exibirMensagem(jsonData.message, jsonData.success ? "sucesso" : "erro");

                if (jsonData.success) {
                    // Login bem-sucedido, redirecione para a página desejada após 7 segundos
                    setTimeout(function() {
                        window.location.href = "/";
                    }, 7000);
                }
            })
            .catch(error => {
                console.error("Erro ao processar o formulário:", error);
                exibirMensagem("Erro ao processar o formulário. Verifique a console para mais detalhes.", "erro");
            });

        return false; // Evita o envio tradicional do formulário
    }



    // Função para exibir mensagens
    function exibirMensagem(mensagem, tipo) {
        var mensagemBanner = document.getElementById("mensagem-banner");
        var progressBar = document.getElementById("progress-bar");
        var mensagemTexto = document.getElementById("mensagem-texto");

        mensagemBanner.style.display = "block";

        // Remover classes existentes
        mensagemBanner.classList.remove("alert-success", "alert-danger");
        progressBar.classList.remove("bg-success", "bg-danger");

        if (tipo === "sucesso") {
            mensagemBanner.classList.add("alert-success");
            progressBar.classList.add("bg-success");
        } else if (tipo === "erro") {
            mensagemBanner.classList.add("alert-danger");
            progressBar.classList.add("bg-danger");
        }

        progressBar.style.width = "100%";
        mensagemTexto.innerHTML = mensagem;

        var tempoTotal = 7000; // Tempo total de exibição em milissegundos
        var intervalo = 100; // Intervalo para atualização da barra de progresso

        var progresso = 0;

        var animacao = setInterval(function() {
            progressBar.style.width = (progresso / tempoTotal) * 100 + "%";
            progresso += intervalo;

            if (progresso >= tempoTotal) {
                clearInterval(animacao);
                mensagemBanner.style.display = "none";
            }
        }, intervalo);
    }

    // Verifica se há mensagens de erro na URL e exibe-as
    var urlParams = new URLSearchParams(window.location.search);
    var erroMessage = urlParams.get('erro');

    if (erroMessage) {
        exibirMensagem(erroMessage, "erro");
    }
</script>

<?php include 'layout/footer.php'; ?>